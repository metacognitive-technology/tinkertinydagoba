<!DOCTYPE html>
<html>
  <head>
    <link rel="shortcut icon" href="./favicon.ico">
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>TinkerTiny - A minimal graph editor for your browser</title>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    <link href="./bootstrap.min.css" rel="stylesheet">

    <script type="text/javascript" src="https://unpkg.com/vis-data@latest/peer/umd/vis-data.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network@latest/peer/umd/vis-network.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/vis-network/styles/vis-network.min.css"/>

    <script type="text/javascript" src="./dev/js/filesaver.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js" integrity="sha512-GZ1RIgZaSc8rnco/8CXfRdCpDxRCphenIiZ2ztLy3XQfCbQUSCuk8IudvNHxkRA3oUg6q0qejgN/qqyG1duv5Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
   
    <link rel="stylesheet" href="./dev/js/jqwidgets/styles/jqx.base.css" type="text/css" />
    <script type="text/javascript" src="./dev/js/jqwidgets/jqxcore.js"></script>
    <script type="text/javascript" src="./dev/js/jqwidgets/jqxbuttons.js"></script>
    <script type="text/javascript" src="./dev/js/jqwidgets/jqxscrollbar.js"></script>
    <script type="text/javascript" src="./dev/js/jqwidgets/jqxlistbox.js"></script>
    <script type="text/javascript" src="./dev/js/jqwidgets/jqxdropdownlist.js"></script>
    <script type="text/javascript" src="./dev/js/jqwidgets/jqxcombobox.js"></script>
    <script type="text/javascript" src="./dev/js/jqwidgets/jqxinput.js"></script>
    <script type="text/javascript" src="./dev/js/jqwidgets/jqxtoolbar.js"></script>
    <script type="text/javascript" src="./dev/js/jqwidgets/jqxcolorpicker.js"></script>
 
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/underscore@1.13.4/underscore-umd-min.js"></script>
    <link href="./dev/fontawesome/css/all.css" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="vis-network-editor.css"/>

    <script type="text/javascript" src="dagoba.js"></script>
    <script type="text/javascript" src="gremlin-parser.js"></script>
    <script type="text/javascript" src="genealogy-data.js"></script>
    <script type="text/javascript" src="tab-manager.js"></script>
    <script type="text/javascript" src="dagoba-integration.js"></script>
    <script type="text/javascript" src="vis-network-editor.js"></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.5.2/bootbox.min.js"></script>
 

    <script>
      $(document).ready(() =>{
        // Verify critical libraries are loaded
        if (typeof Dagoba === 'undefined') {
          console.error('Dagoba is not loaded!');
          alert('Error: Dagoba library failed to load. Please check the console.');
          return;
        }
        
        if (typeof window.GremlinParser === 'undefined') {
          console.warn('GremlinParser is not loaded. Queries will not work.');
        }
        
        initWidgets()
        initVis()  // Initialize vis options first
        window.TabManager.init()  // Initialize tab manager
        initDagobaGraph()  // Then initialize Dagoba graph which will render
      }) 
    </script>
  </head>
  <body onbeforeunload="aboutToLeavePage(event) ">   
      <div class="row">
        <div class="col-sm-1">
              <img src="tinkertoy-graph.png" id="logo">
        </div>
        <div class="col-sm-10">
          <div id="toolbarMain"></div>
          <div id="toolbarArrangeAndHideShow"></div>
          <div id="toolbarAddAndStyle"></div>
        </div>
        <div class="col-sm-1 github-issues">
          <a href="https://github.com/metacognitive-technology/tinkertiny/issues" target="_blank"><i class="fa-brands fa-github fa-2xl"></i></a>
    </div>

      </div>
      <div class="row">
        <div id="vis-config" hidden></div>
        <input id="file-input" type="file" name="name" style="display: none;" />
        
        <!-- Tab Container -->
        <div class="col-sm-12" style="margin-bottom: 10px;">
          <div id="tab-container" style="display: flex; flex-wrap: wrap; gap: 5px; padding: 5px; background-color: #f5f5f5; border-bottom: 2px solid #ddd;"></div>
        </div>
        
        <div class="col-sm-9">
          <div id="mynetwork"></div>
        </div>
        <div class="col-sm-3" id="query-panel">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h4>Gremlin Queries</h4>
              <div style="margin-bottom: 5px;">
                <strong>Load Data Sets:</strong><br>
                <button class="btn btn-xs btn-info" onclick="loadMatthewGenealogy()" style="margin: 2px;">Matthew</button>
                <button class="btn btn-xs btn-info" onclick="loadLukeGenealogy()" style="margin: 2px;">Luke</button>
                <button class="btn btn-xs btn-info" onclick="loadInterstateData()" style="margin: 2px;">Interstates</button>
                <button class="btn btn-xs btn-success" onclick="generateRandomGraph()" style="margin: 2px;">ðŸŽ² Random Graph</button>
              </div>
              <button class="btn btn-sm btn-primary" onclick="saveCurrentQuery()" style="margin: 5px 0;">Save Query</button>
              <button class="btn btn-sm btn-info" onclick="toggleLukeLayer()" style="margin: 5px 0;">Toggle Luke 3</button>
            <button class="btn btn-sm btn-success" onclick="exportGraphSON()" style="margin: 5px 0;">Export GraphSON</button>
            <button class="btn btn-sm btn-warning" onclick="importGraphSONFromFile()" style="margin: 5px 0;">Import GraphSON</button>
            <button class="btn btn-sm btn-danger" onclick="resetGraph()" style="margin: 5px 0;" title="Clear localStorage and reset to empty graph">Reset Graph</button>
            <button class="btn btn-sm btn-danger" onclick="clearAllLocalStorage()" style="margin: 5px 0;" title="Clear all localStorage data (tabs, scripts, graph, queries)">Clear All Data</button>
            <button class="btn btn-sm btn-default" onclick="showGremlinHelp()" style="margin: 5px 0;">Help</button>
            </div>
            <div class="panel-body">
              <!-- Script Library -->
              <div class="panel panel-default" style="margin-bottom: 10px;">
                <div class="panel-heading">
                  <h5>Script Library</h5>
                  <button class="btn btn-xs btn-primary" onclick="saveToScriptLibrary()" style="float: right; margin-top: -25px;">Save Current</button>
                </div>
                <div class="panel-body" style="padding: 5px;">
                  <div style="margin-bottom: 5px;">
                    <label style="font-size: 0.9em;">Category:</label>
                    <select id="script-category-select" class="form-control" style="font-size: 0.9em;">
                      <option value="all">All Categories</option>
                    </select>
                  </div>
                  <div id="script-library-list" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
              </div>
              
              <div id="saved-queries-list"></div>
              <div id="query-editor-container" style="margin-top: 10px;">
                <textarea id="query-editor" class="form-control" rows="5" placeholder="Enter Gremlin query (e.g., v({name: 'Jesus Christ'}))"></textarea>
                <button class="btn btn-sm btn-success" onclick="executeQuery()" style="margin-top: 5px;">Execute</button>
                <button class="btn btn-sm btn-warning" onclick="clearQueryResults()" style="margin-top: 5px;">Clear Results</button>
                <div style="margin-top: 5px;">
                  <label>Visualize in tab:</label>
                  <select id="result-tab-select" class="form-control" style="font-size: 0.9em;">
                    <option value="current">Current Tab</option>
                  </select>
                </div>
              </div>
              <div id="query-results" style="margin-top: 10px; max-height: 200px; overflow-y: auto;"></div>
              
              <!-- Properties Panel -->
              <div id="properties-panel" style="margin-top: 15px; display: none;">
                <h5>Properties</h5>
                <div id="properties-content" style="background-color: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 3px; font-size: 0.9em; max-height: 300px; overflow-y: auto;"></div>
              </div>
            </div>
          </div>
          
          <!-- Geographic Layout Panel -->
          <div class="panel panel-default" style="margin-top: 10px;">
            <div class="panel-heading">
              <h5>Geographic Layout</h5>
            </div>
            <div class="panel-body">
              <div class="form-group" style="margin-bottom: 10px;">
                <label for="lat-property">Latitude Property:</label>
                <input type="text" id="lat-property" class="form-control" placeholder="e.g., latitude, lat" style="font-size: 0.9em;">
              </div>
              <div class="form-group" style="margin-bottom: 10px;">
                <label for="lng-property">Longitude Property:</label>
                <input type="text" id="lng-property" class="form-control" placeholder="e.g., longitude, lng, lon" style="font-size: 0.9em;">
              </div>
              <button class="btn btn-sm btn-primary" onclick="applyGeographicLayout()" style="margin-right: 5px;">Apply Geographic Layout</button>
              <button class="btn btn-sm btn-default" onclick="clearGeographicLayout()">Clear Layout</button>
            </div>
          </div>
          
          <!-- Gremlin Log Panel -->
          <div class="panel panel-default" style="margin-top: 10px;">
            <div class="panel-heading">
              <h5>Gremlin Log</h5>
              <button class="btn btn-xs btn-default" onclick="clearGremlinLog()" style="float: right; margin-top: -25px;">Clear Log</button>
            </div>
            <div class="panel-body" style="padding: 5px;">
              <div id="gremlin-log" style="background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 3px; padding: 10px; font-family: monospace; font-size: 0.85em; max-height: 300px; overflow-y: auto; min-height: 100px;"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Gremlin Help Panel -->
      <div id="gremlin-help-panel" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: auto;">
        <div style="background: white; margin: 20px auto; max-width: 900px; padding: 20px; border-radius: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">Gremlin Query Language Reference</h3>
            <button class="btn btn-default" onclick="hideGremlinHelp()" style="font-size: 20px; line-height: 1; padding: 5px 10px;">&times;</button>
          </div>
          <div id="gremlin-help-content" style="max-height: calc(100vh - 150px); overflow-y: auto;">
            <!-- Content will be populated by JavaScript -->
          </div>
        </div>
      </div>
  </body>
</html>
